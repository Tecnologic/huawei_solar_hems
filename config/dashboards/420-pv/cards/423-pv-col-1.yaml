title: Energy Management
type: entities
state_color: true
show_header_toggle: true
show_state: true
entities:
  - entities:
      - entity: switch.inverter_inverter_on_off
        name: Inverter
        entities:
          - entity: sensor.inverter_active_power
            name: ActivePower
            format: precision0
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
        state_color: true
        toggle: false
      - entity: sensor.battery_status
        name: Batteries
        entities:
          - entity: sensor.battery_state_of_capacity
            name: SOC
            format: precision0
          - entity: sensor.batteries_charge_discharge_power
            name: ChargeDischarge
            format: precision0
        type: custom:multiple-entity-row
        secondary_info: last-changed
        icon: mdi:home-battery-outline
        show_state: true
        state_color: true
        toggle: false
        style: |
          :host {
            {% if states('sensor.battery_status') == 'Running' %}
              --paper-item-icon-color: #fdd835;
            {% endif %}
          }
    type: custom:fold-entity-row
    head:
      entity: sensor.inverter_inverter_state
      name: PV system monitoring
      secondary_info: last-changed
      show_state: true
      state_color: true
      icon: mdi:solar-power-variant-outline
      style: |
        :host {
          {% if states('sensor.inverter_inverter_state') == 'Grid-Connected, Grid-Connected normally' %}
            --paper-item-icon-color: #fdd835;
          {% endif %}
        }
  - entities:
      - entity: binary_sensor.epex_spot_data_update
        attribute: last_update
        name: Last update
        format: datetime
        entities:
          - entity: sensor.epex_spot_data_quantile
            name: Quantile
            format: precision3
          - entity: sensor.epex_spot_data_net_price
            name: NetPrice
            format: precision3
          - entity: binary_sensor.epex_spot_data_update
            type: attribute
            attribute: next_poll_time
            name: Next
            format: time
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
        toggle: false
      - entity: binary_sensor.epex_spot_data_update
        name: Data for tomorrow
        entities:
          - entity: binary_sensor.epex_spot_data_update
            type: attribute
            attribute: last_data
            name: Last
            format: datetime
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
        toggle: false
    type: custom:fold-entity-row
    head:
      entity: automation.epex_spot_fetch_data
      name: EPEX Spot monitoring
      secondary_info: last-changed
  - entities:
      - entity: sensor.solcast_pv_forecast_zeitpunkt_letzter_api_abruf
        name: Last update
        format: datetime
        entities:
          - entity: sensor.solcast_pv_forecast_power_now
            name: State
            format: precision0
          - entity: sensor.solcast_pv_forecast_api_update
            name: Next
            format: time
          - entity: sensor.solcast_pv_forecast_api_limit
            name: Limit
            format: precision0
          - entity: sensor.solcast_pv_forecast_verwendete_api_abrufe
            name: Today
            format: precision0
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
        toggle: false
        style: |
          :host {
            {% if states('sensor.solcast_pv_forecast_verwendete_api_abrufe')|float(0) > 0 %}
              --paper-item-icon-color: #fdd835;
            {% endif %}
          }
      - entity: sensor.zu_hause_sun_deconz_daylight
        name: Sun phase for today
        entities:
          - entity: sensor.zu_hause_sun_rising
            name: Rising
            format: time
          - entity: sensor.zu_hause_sun_pv_excess_start
            name: PVExcessStart
            format: time
          - entity: sensor.zu_hause_sun_solar_noon
            name: SolarNoon
            format: time
          - entity: sensor.zu_hause_sun_prediction_end
            name: PredictionHorizon
            format: time
          - entity: sensor.zu_hause_sun_pv_excess_end
            name: PVExcessEnd
            format: time
          - entity: sensor.zu_hause_sun_setting
            name: Setting
            format: time
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
        style: |
          :host {
            {% if state_attr('sensor.zu_hause_sun_deconz_daylight','daylight') %}
              --paper-item-icon-color: #fdd835;
            {% endif %}
          }
      - entity: sensor.solcast_forecast_remaining_today_every_minute
        name: Solar forecast for today
        format: precision3
        entities:
          - entity: sensor.solcast_forecast_remaining_today_every_minute
            type: attribute
            attribute: pv_excess_start_energy
            name: PVExcessStart
            format: precision3
            unit: kWh
          - entity: sensor.solcast_forecast_remaining_today_every_minute
            type: attribute
            attribute: solar_noon_energy
            name: SolarNoon
            format: precision3
            unit: kWh
          - entity: sensor.solcast_forecast_remaining_today_every_minute
            type: attribute
            attribute: prediction_end_energy
            name: PredictionHorizon
            format: precision3
            unit: kWh
          - entity: sensor.solcast_forecast_remaining_today_every_minute
            type: attribute
            attribute: pv_excess_end_energy
            name: PVExcessEnd
            format: precision3
            unit: kWh
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
        style: |
          :host {
            {% if states('sensor.solcast_forecast_remaining_today_every_minute')|float(0) > 0 %}
              --paper-item-icon-color: #fdd835;
            {% endif %}
          }
    type: custom:fold-entity-row
    head:
      entity: automation.solcast_pv_forecast_api_update
      name: Solcast PV forecast
      secondary_info: last-changed
  - entities:
      - entity: sensor.optim_status
        name: Latest optimization results
        entities:
          - entity: sensor.p_pv_forecast
            name: Solar
            format: precision0
          - entity: sensor.p_load_forecast
            name: House
            format: precision0
          - entity: sensor.p_deferrable0
            name: Deferrable0
            format: precision0
          - entity: sensor.p_grid_forecast
            name: Grid
            format: precision0
          - entity: sensor.p_batt_forecast
            name: Batteries
            format: precision0
          - entity: sensor.soc_batt_forecast
            name: SOC
            format: precision2
          - entity: sensor.p_hybrid_inverter
            name: Inverter
            format: precision0
          - entity: sensor.p_pv_curtailment
            name: Curtailment
            format: precision0
          - entity: sensor.unit_load_cost
            name: Cost
            format: precision2
          - entity: sensor.unit_prod_price
            name: Price
            format: precision2
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
      - entity: sensor.total_cost_fun_value
        name: Cost profit
        format: precision2
        entities:
          - entity: sensor.emhass_prediction_horizon
            name: PredictionHorizon
            format: precision0
          - entity: sensor.emhass_prediction_horizon
            type: attribute
            attribute: prediction_end_time_tomorrow
            name: End
            format: datetime
          - entity: sensor.epex_spot_data_net_price_1
            name: Data
            format: precision3
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
      - entity: sensor.load_forecast_remaining_today_every_minute
        name: Load forecast for today
        format: precision3
        entities:
          - entity: sensor.load_forecast_remaining_today_every_minute
            type: attribute
            attribute: pv_excess_start_energy
            name: PVExcessStart
            format: precision3
            unit: kWh
          - entity: sensor.load_forecast_remaining_today_every_minute
            type: attribute
            attribute: solar_noon_energy
            name: SolarNoon
            format: precision3
            unit: kWh
          - entity: sensor.load_forecast_remaining_today_every_minute
            type: attribute
            attribute: prediction_end_energy
            name: PredictionHorizon
            format: precision3
            unit: kWh
          - entity: sensor.load_forecast_remaining_today_every_minute
            type: attribute
            attribute: pv_excess_end_energy
            name: PVExcessEnd
            format: precision3
            unit: kWh
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
    type: custom:fold-entity-row
    head:
      entity: automation.emhass_naive_mpc_optim_forecast
      name: EMHASS - naive MPC optimization
      secondary_info: last-triggered
  - entities:
      - entity: binary_sensor.batteries_maximum_charging_power
        name: Maximum charging power
        entities:
          - entity: sensor.batteries_end_of_charge_time
            name: Remaining
          - entity: sensor.batteries_end_of_charge_energy
            name: Remaining
            format: precision2
          - entity: number.batteries_end_of_charge_soc
            name: Max
          - entity: sensor.battery_state_of_capacity
            name: State
          - entity: sensor.batteries_state_of_energy
            name: State
          - entity: sensor.batteries_charge_power_mean_30min
            name: Ø30mins
            format: precision0
          - entity: sensor.batteries_charge_power
            name: State
            format: precision0
          - entity: number.batteries_maximum_charging_power
            name: Max
            format: precision0
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
      - entity: binary_sensor.batteries_maximum_discharging_power
        name: Maximum discharging power
        entities:
          - entity: sensor.batteries_end_of_discharge_time
            name: Remaining
            format: precision2
          - entity: number.batteries_peak_shaving_soc
            name: PeakShaving
          - entity: number.batteries_backup_power_soc
            name: BackupPower
          - entity: number.batteries_end_of_discharge_soc
            name: Min
          - entity: sensor.battery_state_of_capacity
            name: State
          - entity: sensor.batteries_state_of_energy
            name: State
          - entity: sensor.batteries_discharge_power_mean_24h
            name: Ø24h
            format: precision0
          - entity: sensor.batteries_discharge_power
            name: State
            format: precision0
          - entity: number.batteries_maximum_discharging_power
            name: Max
            format: precision0
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
      - entity: binary_sensor.batteries_forcible_charge
        name: Forcible charge
        entities:
          - entity: sensor.batteries_forcible_charge
            type: attribute
            attribute: mode
            name: Mode
          - entity: sensor.batteries_forcible_charge
            type: attribute
            attribute: setting
            name: Setting
          - entity: sensor.batteries_forcible_charge
            type: attribute
            attribute: charge_power
            name: MaxCharge
            unit: W
          - entity: sensor.batteries_forcible_charge
            type: attribute
            attribute: discharge_power
            name: MaxDischarge
            unit: W
          - entity: sensor.batteries_forcible_charge
            type: attribute
            attribute: target_soc
            name: Max
            unit: "%"
          - entity: sensor.batteries_forcible_charge
            type: attribute
            attribute: duration
            name: Duration
            unit: min
          - entity: sensor.batteries_forcible_charge
            name: State
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
      - entity: binary_sensor.batteries_charge_from_grid
        name: Charge from Grid
        entities:
          - entity: number.batteries_grid_charge_maximum_power
            name: MaxCharge
          - entity: number.batteries_grid_charge_cutoff_soc
            name: Max
          - entity: switch.batteries_charge_from_grid
            name: State
          - entity: sensor.p_load_forecast
            name: House
            format: precision0
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
      - entity: select.batteries_working_mode
        name: Working Mode
        entities:
          - entity: sensor.battery_capacity_control_periods
            name: CapacityControlPeriods
          - entity: sensor.battery_fixed_charging_periods
            name: FixedChargingPeriods
          - entity: sensor.battery_time_of_use_periods
            name: TimeOfUsePeriods
          - entity: select.battery_excess_pv_energy_use_in_tou
            name: ExcessPVEnergyUse
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
      - entity: binary_sensor.batteries_maximum_charging_power
        attribute: pv_excess_start_energy
        name: Charging forecast for today
        format: precision3
        entities:
          - entity: binary_sensor.batteries_maximum_charging_power
            type: attribute
            attribute: charge_energy_forecast_pv_excess_start
            name: PVExcessStart
            format: precision3
            unit: kWh
          - entity: binary_sensor.batteries_maximum_charging_power
            type: attribute
            attribute: charge_energy_forecast_solar_noon
            name: SolarNoon
            format: precision3
            unit: kWh
          - entity: binary_sensor.batteries_maximum_charging_power
            type: attribute
            attribute: charge_energy_forecast_prediction_end
            name: PredictionHorizon
            format: precision3
            unit: kWh
          - entity: binary_sensor.batteries_maximum_charging_power
            type: attribute
            attribute: charge_energy_forecast_pv_excess_end
            name: PVExcessEnd
            format: precision3
            unit: kWh
        type: custom:multiple-entity-row
        secondary_info: last-changed
        show_state: true
        style: |
          :host {
            {% if states('sensor.solcast_forecast_remaining_today_every_minute')|float(0) > 0 %}
              --paper-item-icon-color: #fdd835;
            {% endif %}
          }
    type: custom:fold-entity-row
    head:
      entity: automation.huawei_solar_batteries_charge_discharge_control
      name: Batteries Charge-Discharge automation
      secondary_info: last-triggered